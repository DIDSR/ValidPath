<!DOCTYPE html>
<html class="writer-html5" lang="en" xmlns:mso="urn:schemas-microsoft-com:office:office" xmlns:msdt="uuid:C2F41010-65B3-11d1-A29F-00AA00C14882" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>annotation.patch_extractor &mdash; SlidePro 1.0.0 documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/sphinx_highlight.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 

<!--[if gte mso 9]><xml>
<mso:CustomDocumentProperties>
<mso:display_urn_x003a_schemas-microsoft-com_x003a_office_x003a_office_x0023_SharedWithUsers msdt:dt="string">Kahaki, Seyed</mso:display_urn_x003a_schemas-microsoft-com_x003a_office_x003a_office_x0023_SharedWithUsers>
<mso:SharedWithUsers msdt:dt="string">811;#Kahaki, Seyed</mso:SharedWithUsers>
</mso:CustomDocumentProperties>
</xml><![endif]-->
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../index.html" class="icon icon-home"> SlidePro
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../modules.html">slidepro</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">SlidePro</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">annotation.patch_extractor</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for annotation.patch_extractor</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Created on Mon Nov  6 11:23:07 2021</span>


<span class="sd">@author: SeyedM.MousaviKahaki (mousavikahaki@gmail.com)</span>

<span class="sd">Title:        WSI Patch Generatore</span>


<span class="sd">Description:  This code inputs should be run after the TissueRefinement code</span>
<span class="sd">              It will extract several patches ($Number_of_Patches=300)</span>
<span class="sd">              from specified images</span>



<span class="sd">Input:        Image: Extracted Annotation</span>

<span class="sd">Output:       Several patches with specific size</span>


<span class="sd">version =&#39;3.0&#39;</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="c1">##############################   General Imports</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">cv2</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="nn">PIL</span> <span class="kn">import</span> <span class="n">Image</span>
<span class="kn">import</span> <span class="nn">glob</span>
<span class="kn">import</span> <span class="nn">h5py</span>
<span class="kn">from</span> <span class="nn">skimage.io</span> <span class="kn">import</span> <span class="n">imsave</span><span class="p">,</span> <span class="n">imread</span>
<span class="kn">from</span> <span class="nn">skimage.transform</span> <span class="kn">import</span> <span class="n">resize</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">misc</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="kn">from</span> <span class="nn">skimage.metrics</span> <span class="kn">import</span> <span class="n">structural_similarity</span> <span class="k">as</span> <span class="n">compare_ssim</span>




<span class="c1"># ##############################  inputs</span>
<span class="c1"># png_extract = parameters.PatchGenerator_png_extract</span>
<span class="c1"># hdf5 = False #parameters.PatchGenerator_hdf5</span>
<span class="c1"># open_dataset= parameters.PatchGenerator_open_dataset</span>
<span class="c1"># Aplha = parameters.PatchGenerator_Aplha</span>
<span class="c1"># INPUTDIR = parameters.PatchGenerator_INPUTDIR</span>
<span class="c1"># OUTPUTDIR = parameters.PatchGenerator_OUTPUTDIR</span>

<span class="c1"># INPUTDIR = &#39;Oklahoma_Extracted_New_FixedCircle_processed_Augmented_combined/&#39;</span>
<span class="c1"># OUTPUTDIR = &#39;C:/DATA/Oklahoma_extracted_cutted_Augmented/&#39;</span>
<span class="c1"># DatasetFile = &#39;C:/DATA/Aperio_dataset_v9.csv&#39;</span>

<span class="c1"># INPUTDIR = &#39;AperioAnnotations_NonCancer/&#39;</span>
<span class="c1"># OUTPUTDIR = &#39;C:/DATA/AperioAnnotations_NonCancer_Patches/&#39;</span>
<span class="c1"># DatasetFile = &#39;C:/DATA/Aperio_dataset_v9.csv&#39;</span>

<span class="n">INPUTDIR</span> <span class="o">=</span> <span class="s1">&#39;2_extracted_cutted_Augmented/3DHistech/ExtractedAnnotation/&#39;</span>
<span class="n">OUTPUTDIR</span> <span class="o">=</span> <span class="s1">&#39;C:/DATA/2_extracted_cutted_Augmented/3DHistech/&#39;</span>
<span class="n">DatasetFile</span> <span class="o">=</span> <span class="s1">&#39;C:/DATA/Aperio_dataset_v9.csv&#39;</span>

<span class="n">hdf5_file</span><span class="o">=</span> <span class="n">OUTPUTDIR</span><span class="o">+</span><span class="s2">&quot;dataset.hdf5&quot;</span>
<span class="n">root_directory</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;C:/DATA/&#39;</span><span class="o">+</span><span class="n">INPUTDIR</span><span class="o">+</span><span class="s1">&#39;*&#39;</span><span class="p">)</span>

<span class="c1">##############################  Number of Random Patches Per Region</span>
<span class="c1"># Number_of_Patches = parameters.PatchGenerator_Number_of_Patches</span>
<span class="n">Number_of_Patches</span> <span class="o">=</span> <span class="mi">36</span>
<span class="c1">##############################  input patch size  y==width   x==height</span>
<span class="c1"># input_x = parameters.PatchGenerator_input_x   </span>
<span class="c1"># input_y = parameters.PatchGenerator_input_y</span>

<span class="c1">##############################</span>
<span class="n">cwd</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>


<span class="c1"># # Create folders if there aren&#39;t</span>
<span class="c1"># hdf5_dir = Path(&quot;data\\hdf5_files\\&quot;)</span>
<span class="c1"># hdf5_dir.mkdir(parents=True, exist_ok=True)</span>
<span class="c1"># png_dir = Path(&quot;data/png_files/&quot;)</span>
<span class="c1"># hdf5_dir.mkdir(parents=True, exist_ok=True)</span>

<span class="n">png_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">OUTPUTDIR</span><span class="o">+</span><span class="s2">&quot;data/png_files/&quot;</span><span class="p">)</span>
<span class="n">png_dir</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># path to str -We need them ahead</span>
<span class="c1"># png_dir=r&quot;data/png_files/&quot;</span>
<span class="c1">#hdf5_dir=r&quot;data\\hdf5_files\\&quot;</span>
<span class="n">png_dir</span><span class="o">=</span><span class="n">OUTPUTDIR</span><span class="o">+</span><span class="s2">&quot;data/png_files/&quot;</span>


<span class="n">Dataset_</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">DatasetFile</span><span class="p">)</span>

<span class="c1">#for on all folders</span>
<div class="viewcode-block" id="gen_patch"><a class="viewcode-back" href="../../annotation.html#annotation.patch_extractor.gen_patch">[docs]</a><span class="k">def</span> <span class="nf">gen_patch</span><span class="p">(</span><span class="n">INPUTDIR</span><span class="p">,</span><span class="n">input_x</span><span class="p">,</span><span class="n">input_y</span><span class="p">,</span><span class="n">Number_of_Patches</span><span class="p">,</span><span class="n">hdf5_file</span><span class="p">,</span><span class="n">DatasetFile</span><span class="p">,</span><span class="n">hdf5</span><span class="p">,</span><span class="n">png_extract</span><span class="p">,</span><span class="n">open_dataset</span><span class="p">,</span><span class="n">Aplha</span><span class="p">,</span><span class="n">OUTPUTDIR</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function a number of pactches from extracted annotations.</span>
<span class="sd">    It can save the extracted annottions to the output directory as defined in inputs.</span>
<span class="sd">    Before running this function, please call annotation.ann_extractor.extract_ann(save_dir, XMLs, WSIs) to generate annotations. </span>
<span class="sd">    The output directory will be generated based on the strucutr of the input directories.</span>
<span class="sd">    IF the WSI Magnification is 13X or 20X, this code will automaticall convert to 20X.</span>
<span class="sd">          </span>
<span class="sd">    :Parameters:</span>
<span class="sd">        root_directory : str</span>
<span class="sd">            Output Directory to save the extracted annotations</span>
<span class="sd">            </span>
<span class="sd">        WSIs : list</span>
<span class="sd">            List of included WSIs</span>
<span class="sd">            </span>
<span class="sd">        XMLs : list</span>
<span class="sd">            List of XML files associated with included WSIs</span>
<span class="sd">            </span>
<span class="sd">    :Returns:</span>
<span class="sd">        None : None</span>
<span class="sd">            None.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">root_directory</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;C:/DATA/&#39;</span><span class="o">+</span><span class="n">INPUTDIR</span><span class="o">+</span><span class="s1">&#39;*&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">root_directory</span><span class="p">:</span>
    
        <span class="n">groupname</span> <span class="o">=</span> <span class="n">filename</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\\</span><span class="s2">&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        
        <span class="c1"># Find Magnification</span>
        <span class="n">FName</span> <span class="o">=</span> <span class="n">groupname</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39;.SVS&#39;</span> 
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># For Aperio</span>
            <span class="c1"># Magnification = Dataset_[Dataset_[&#39;Filename of initial Aperio slide&#39;] == FName][&#39;SVS Magnification&#39;].item()</span>
            <span class="c1"># For 3DHistech</span>
            <span class="n">Magnification</span> <span class="o">=</span> <span class="mi">13</span><span class="c1">#Dataset_[Dataset_[&#39;Filename of initial 3D Histech slide&#39;] == FName][&#39;SVS Magnification&#39;].item()</span>
            <span class="k">if</span> <span class="n">Magnification</span> <span class="o">==</span> <span class="mi">40</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">groupname</span><span class="o">+</span><span class="s1">&#39; Magnification  is 40&#39;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">Magnification</span> <span class="o">==</span> <span class="mi">13</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">groupname</span><span class="o">+</span><span class="s1">&#39; Magnification  is 13&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Magnification is 20&#39;</span><span class="p">)</span>
           
            <span class="n">chck_group_name</span><span class="o">=</span><span class="kc">True</span>
                
           
           
            <span class="n">files</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span> <span class="n">filename</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot;\*.jpg&quot;</span><span class="p">)</span>
        
            <span class="n">files_clean</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="c1"># exclude mask images</span>
            <span class="c1"># i=0</span>
            <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
                <span class="c1">#print(r)</span>
                <span class="n">a</span><span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\\</span><span class="s2">&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">b</span><span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">c</span><span class="o">=</span><span class="n">b</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;mask&quot;</span><span class="p">)</span>
                <span class="c1"># if(c&gt;-1):</span>
                <span class="c1">#     rt=files.pop()[i]\</span>
                <span class="k">if</span><span class="p">(</span><span class="n">c</span><span class="o">==-</span><span class="mi">1</span><span class="p">):</span>
                    <span class="n">files_clean</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
                <span class="c1"># i=i+1</span>
         
          
            <span class="c1"># for on  all images in a folder</span>
            <span class="k">for</span> <span class="n">fl</span> <span class="ow">in</span> <span class="n">files_clean</span><span class="p">:</span>
              
            
                <span class="n">img</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">fl</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">IMREAD_COLOR</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">Magnification</span> <span class="o">==</span> <span class="mi">13</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">groupname</span><span class="o">+</span><span class="s1">&#39; Rescaling 13X to 20X&#39;</span><span class="p">)</span>
                    <span class="n">scale</span> <span class="o">=</span> <span class="mf">0.65</span>
                    <span class="n">img</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> <span class="n">fx</span><span class="o">=</span><span class="n">scale</span><span class="p">,</span> <span class="n">fy</span><span class="o">=</span><span class="n">scale</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="n">cv2</span><span class="o">.</span><span class="n">INTER_AREA</span><span class="p">)</span>
                    
                <span class="k">elif</span> <span class="n">Magnification</span> <span class="o">==</span> <span class="mi">40</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">groupname</span><span class="o">+</span><span class="s1">&#39; Rescaling 40X to 20X&#39;</span><span class="p">)</span>
                    <span class="n">scale</span> <span class="o">=</span> <span class="mf">0.5</span>
                    <span class="n">img</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> <span class="n">fx</span><span class="o">=</span><span class="n">scale</span><span class="p">,</span> <span class="n">fy</span><span class="o">=</span><span class="n">scale</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="n">cv2</span><span class="o">.</span><span class="n">INTER_AREA</span><span class="p">)</span>
                    <span class="c1"># img1 = cv2.resize(img, (0,0), fx=scale, fy=scale, interpolation=cv2.INTER_AREA)</span>
                    <span class="c1"># fig, axs = plt.subplots(1,2,figsize=(15,10))</span>
                    <span class="c1"># axs[0].imshow(img),axs[0].axis(&#39;off&#39;)</span>
                    <span class="c1"># axs[0].set_title(&#39;Original&#39;)</span>
                    <span class="c1"># axs[1].imshow(img1),axs[1].axis(&#39;off&#39;)</span>
                    <span class="c1"># axs[1].set_title(&#39;imgcv2_INTER_AREA&#39;)</span>
                    
                    <span class="c1"># imgcv2_INTER_CUBIC = cv2.resize(img, (0,0), fx=scale, fy=scale, interpolation=cv2.INTER_CUBIC)</span>
                    <span class="c1"># imgcv2_INTER_AREA = cv2.resize(img, (0,0), fx=scale, fy=scale, interpolation=cv2.INTER_AREA)</span>
                    <span class="c1"># imgcv2_INTER_LANCZOS4 = cv2.resize(img, (0,0), fx=scale, fy=scale, interpolation=cv2.INTER_LANCZOS4)</span>
                    <span class="c1"># imgcv2_INTER_NEAREST = cv2.resize(img, (0,0), fx=scale, fy=scale, interpolation=cv2.INTER_NEAREST)</span>
                    <span class="c1"># imgcv2_INTER_LINEAR = cv2.resize(img, (0,0), fx=scale, fy=scale, interpolation=cv2.INTER_LINEAR)</span>
                    
                    <span class="c1"># fig, axs = plt.subplots(2,3,figsize=(15,10))</span>
                    <span class="c1"># # fig.suptitle(&#39;Different Interpolations&#39;)</span>
                    <span class="c1"># axs[0, 0].imshow(img),axs[0,0].axis(&#39;off&#39;)</span>
                    <span class="c1"># axs[0, 0].set_title(&#39;Original&#39;)</span>
                    <span class="c1"># axs[0, 1].imshow(imgcv2_INTER_CUBIC),axs[0,1].axis(&#39;off&#39;)</span>
                    <span class="c1"># axs[0, 1].set_title(&#39;CUBIC&#39;)</span>
                    <span class="c1"># axs[0, 2].imshow(imgcv2_INTER_AREA),axs[0,2].axis(&#39;off&#39;)</span>
                    <span class="c1"># axs[0, 2].set_title(&#39;AREA&#39;)</span>
                    <span class="c1"># axs[1, 0].imshow(imgcv2_INTER_LANCZOS4),axs[1,0].axis(&#39;off&#39;)</span>
                    <span class="c1"># axs[1, 0].set_title(&#39;LANCZOS4&#39;)</span>
                    <span class="c1"># axs[1, 1].imshow(imgcv2_INTER_NEAREST),axs[1,1].axis(&#39;off&#39;)</span>
                    <span class="c1"># axs[1, 1].set_title(&#39;NEAREST&#39;)</span>
                    <span class="c1"># axs[1, 2].imshow(imgcv2_INTER_LINEAR),axs[1,2].axis(&#39;off&#39;)</span>
                    <span class="c1"># axs[1, 2].set_title(&#39;LINEAR&#39;)</span>
                    
                    <span class="c1"># cv2.PSNR(img, imgcv2_INTER_CUBIC)</span>
                    <span class="c1"># (score, diff) = compare_ssim(img, imgcv2_INTER_CUBIC, full=True,multichannel=True)</span>
                    
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Processing 20X&#39;</span><span class="p">)</span>
                
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">img</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">250</span><span class="p">:</span>
                    <span class="k">continue</span>
                
                <span class="c1"># cv2.imshow(&#39;graycsale image&#39;,img)</span>
                <span class="c1"># cv2.waitKey(0)</span>
                <span class="c1"># cv2.destroyAllWindows()</span>
        
                
                <span class="n">rows</span><span class="p">,</span><span class="n">cols</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                
                <span class="n">b</span><span class="o">=</span><span class="n">fl</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
          
                <span class="n">name</span><span class="o">=</span><span class="n">b</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                
             
               
                <span class="c1">#extract patches</span>
                <span class="k">for</span> <span class="n">rng</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Number_of_Patches</span><span class="p">):</span>
             
                    <span class="n">end_name</span> <span class="o">=</span><span class="n">name</span><span class="o">+</span><span class="s2">&quot;_patchnumber_&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">rng</span><span class="p">)</span> 
               
                    
                    <span class="n">done</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">breakLimit</span> <span class="o">=</span> <span class="mi">500</span>
                    <span class="n">breakCount</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">while</span> <span class="n">done</span> <span class="p">:</span> 
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Trying Extract: &quot;</span><span class="o">+</span> <span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;Break Count: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">breakCount</span><span class="p">))</span>
                        <span class="n">breakCount</span> <span class="o">=</span> <span class="n">breakCount</span> <span class="o">+</span> <span class="mi">1</span>
                        <span class="k">if</span> <span class="n">breakCount</span> <span class="o">&gt;</span> <span class="n">breakLimit</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; BREAK on &quot;</span><span class="o">+</span> <span class="n">name</span><span class="p">)</span>
                            <span class="k">break</span>
                        <span class="n">coords</span> <span class="o">=</span> <span class="p">[(</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span><span class="o">*</span><span class="n">rows</span><span class="p">,</span> <span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span><span class="o">*</span><span class="n">cols</span><span class="p">)]</span>
                        <span class="n">x</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">coords</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
                        <span class="k">if</span><span class="p">(</span><span class="n">x</span><span class="o">&gt;</span><span class="p">(</span><span class="n">rows</span><span class="o">-</span><span class="n">input_x</span><span class="o">+</span><span class="mi">1</span><span class="p">)):</span>
                            <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">-</span><span class="n">input_x</span><span class="o">+</span><span class="mi">1</span>
                   
                        <span class="n">y</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">coords</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
                        <span class="k">if</span><span class="p">(</span><span class="n">y</span><span class="o">&gt;</span><span class="p">(</span><span class="n">cols</span><span class="o">-</span><span class="n">input_x</span><span class="o">+</span><span class="mi">1</span><span class="p">)):</span>
                            <span class="n">y</span> <span class="o">=</span> <span class="n">y</span><span class="o">-</span><span class="n">input_y</span><span class="o">+</span><span class="mi">1</span>
                    
                        <span class="n">x_end</span><span class="o">=</span><span class="n">x</span><span class="o">+</span><span class="n">input_x</span>
                        <span class="n">y_end</span><span class="o">=</span><span class="n">y</span><span class="o">+</span><span class="n">input_y</span>
                    
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">color_chk1</span> <span class="o">=</span> <span class="n">img</span><span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">]</span> <span class="o">&gt;</span> <span class="p">[</span><span class="mi">230</span><span class="p">,</span><span class="mi">230</span><span class="p">,</span><span class="mi">230</span><span class="p">]</span><span class="c1">#== [255,255,255]</span>
                            <span class="n">color_chk2</span> <span class="o">=</span> <span class="n">img</span><span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">y_end</span><span class="p">]</span> <span class="o">&gt;</span> <span class="p">[</span><span class="mi">230</span><span class="p">,</span><span class="mi">230</span><span class="p">,</span><span class="mi">230</span><span class="p">]</span><span class="c1">#== [255,255,255]</span>
                            <span class="n">color_chk3</span> <span class="o">=</span> <span class="n">img</span><span class="p">[</span><span class="n">x_end</span><span class="p">,</span> <span class="n">y</span><span class="p">]</span> <span class="o">&gt;</span> <span class="p">[</span><span class="mi">230</span><span class="p">,</span><span class="mi">230</span><span class="p">,</span><span class="mi">230</span><span class="p">]</span><span class="c1">#== [255,255,255]</span>
                            <span class="n">color_chk4</span> <span class="o">=</span> <span class="n">img</span><span class="p">[</span><span class="n">x_end</span><span class="p">,</span> <span class="n">y_end</span><span class="p">]</span> <span class="o">&gt;</span> <span class="p">[</span><span class="mi">230</span><span class="p">,</span><span class="mi">230</span><span class="p">,</span><span class="mi">230</span><span class="p">]</span><span class="c1">#== [255,255,255]</span>
                            <span class="n">color_chk5</span> <span class="o">=</span> <span class="n">img</span><span class="p">[</span><span class="nb">round</span><span class="p">((</span><span class="n">x</span><span class="o">+</span><span class="n">x_end</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">),</span> <span class="nb">round</span><span class="p">((</span><span class="n">y</span><span class="o">+</span><span class="n">y_end</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">)]</span> <span class="o">&gt;</span> <span class="p">[</span><span class="mi">230</span><span class="p">,</span><span class="mi">230</span><span class="p">,</span><span class="mi">230</span><span class="p">]</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="k">continue</span>
                        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">color_chk1</span><span class="p">)</span> <span class="o">==</span> <span class="nb">any</span><span class="p">(</span><span class="n">color_chk2</span><span class="p">)</span> <span class="o">==</span> <span class="nb">any</span><span class="p">(</span><span class="n">color_chk3</span><span class="p">)</span> <span class="o">==</span> <span class="nb">any</span><span class="p">(</span><span class="n">color_chk5</span><span class="p">)</span><span class="o">==</span> <span class="kc">False</span> <span class="p">:</span>
                        <span class="c1"># if any(color_chk1) == any(color_chk2) == any(color_chk3) == any(color_chk4) == any(color_chk5)== False : </span>
                        <span class="c1"># if any(color_chk1) == any(color_chk2) == False : </span>
                            <span class="n">cropped_image</span> <span class="o">=</span> <span class="n">img</span><span class="p">[</span><span class="n">x</span><span class="p">:</span><span class="n">x_end</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span><span class="n">y_end</span><span class="p">]</span>
                            
                            
                            <span class="c1">#create png files of patches</span>
                            <span class="k">if</span> <span class="n">png_extract</span><span class="o">==</span><span class="kc">True</span><span class="p">:</span>
                                <span class="n">png_file</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">OUTPUTDIR</span><span class="o">+</span><span class="s2">&quot;data/png_files/&quot;</span><span class="o">+</span><span class="n">groupname</span><span class="o">+</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>
                                <span class="n">png_file</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Crearing &quot;</span><span class="o">+</span><span class="n">png_dir</span> <span class="o">+</span><span class="n">groupname</span><span class="o">+</span><span class="s2">&quot;/&quot;</span><span class="o">+</span><span class="n">end_name</span><span class="o">+</span><span class="s2">&quot;.png&quot;</span><span class="p">)</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="n">cv2</span><span class="o">.</span><span class="n">imwrite</span><span class="p">(</span><span class="n">png_dir</span> <span class="o">+</span> <span class="n">groupname</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span><span class="n">end_name</span><span class="o">+</span><span class="s2">&quot;.png&quot;</span><span class="p">,</span> <span class="n">cropped_image</span><span class="p">)</span>
                                <span class="k">except</span><span class="p">:</span>
                                    <span class="k">continue</span>
                                
                              
                            <span class="c1">#create a hdf5 file of all patches</span>
                            <span class="k">if</span><span class="p">(</span><span class="n">hdf5</span><span class="o">==</span><span class="kc">True</span><span class="p">):</span>
                                <span class="k">if</span> <span class="n">open_dataset</span><span class="o">==</span><span class="kc">True</span><span class="p">:</span>    
                                    <span class="n">dataset</span> <span class="o">=</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">hdf5_file</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span>
                                    <span class="n">open_dataset</span><span class="o">=</span><span class="kc">False</span>
              
                                <span class="k">if</span> <span class="n">chck_group_name</span><span class="o">==</span><span class="kc">True</span><span class="p">:</span>
                                    
                                    <span class="nb">print</span><span class="p">(</span><span class="n">groupname</span><span class="o">+</span><span class="s2">&quot;_is--&gt;&gt;&gt;&gt;&gt; new group name.&quot;</span><span class="p">)</span>
                                    <span class="n">grp</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">create_group</span><span class="p">(</span><span class="n">groupname</span><span class="p">);</span>
                                    <span class="n">chck_group_name</span><span class="o">=</span><span class="kc">False</span>
                                    
                        
                                
                                <span class="n">dset</span> <span class="o">=</span> <span class="n">grp</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="n">end_name</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">cropped_image</span><span class="p">)</span>
                                <span class="nb">print</span><span class="p">(</span><span class="n">end_name</span><span class="o">+</span><span class="s2">&quot;_is new dataset on  &quot;</span><span class="o">+</span><span class="n">groupname</span><span class="o">+</span><span class="s2">&quot; group&quot;</span><span class="p">)</span>
                               
                            <span class="n">done</span><span class="o">=</span><span class="kc">False</span> 
        <span class="k">except</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Can not Process &quot;</span><span class="o">+</span><span class="n">FName</span><span class="p">)</span>
    <span class="k">if</span><span class="p">(</span><span class="n">hdf5</span><span class="o">==</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">dataset</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>
	
	
	



</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, Seyed Kahaki.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>